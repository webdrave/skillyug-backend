// This is your Prisma schema file for Skillyug 2.0
// Refactored for Auth.js, scalability, and new product features.
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// AUTHENTICATION (Auth.js)
// ========================================

model User {
  id            String    @id @default(cuid())
  fullName      String?   @map("full_name")
  email         String?   @unique
  password      String?   @db.Text // Hashed password for local authentication
  emailVerified DateTime? @map("email_verified") // Auth.js standard field

  // --- OTP VERIFICATION FIELDS ---
  otp        String?   @db.Text // Hashed OTP
  otpExpires DateTime? @map("otp_expires") // Expiration time for the OTP
  isVerified Boolean   @default(false) @map("is_verified")

  // --- PASSWORD RESET FIELDS ---
  passwordResetToken   String?   @unique @map("password_reset_token") @db.Text
  passwordResetExpires DateTime? @map("password_reset_expires")

  image     String? // Avatar URL
  bio       String? // User bio for profile page
  userType  UserType @default(STUDENT) @map("user_type")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Auth.js relations
  accounts Account[]
  sessions Session[]

  // App-specific relations
  coursesAsMentor Course[]           @relation("CourseMentor")
  purchases       Purchase[]
  enrollments     Enrollment[]
  reviews         Review[]
  adminActions    AdminAction[]
  threads         DiscussionThread[]
  posts           DiscussionPost[]
  certificates    Certificate[]
  notifications   Notification[]
  streamViews     StreamViewer[]
  quizResponses   QuizResponse[]
  sessionAttendance SessionAttendance[]
  
  // Mentor relations
  mentorProfile        MentorProfile?
  sentMentorInvitations MentorInvitation[] @relation("InvitedBy")
  
  // Mentor Channel System (ONE-CHANNEL-PER-MENTOR)
  mentorChannel        MentorChannel?     @relation("MentorChannel")
  classSessions        ClassSession[]     @relation("ClassSessionMentor")
}

// ========================================
// MENTOR INVITATION & PROFILE
// ========================================

model MentorInvitation {
  id        String                 @id @default(cuid())
  email     String
  token     String                 @unique @db.Text
  status    MentorInvitationStatus @default(PENDING)
  expiresAt DateTime               @map("expires_at")
  createdAt DateTime               @default(now()) @map("created_at")
  usedAt    DateTime?              @map("used_at")

  // Relations
  invitedBy   User   @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  invitedById String @map("invited_by_id")

  @@index([email])
  @@index([token])
  @@map("mentor_invitations")
}

enum MentorInvitationStatus {
  PENDING
  USED
  EXPIRED
  CANCELLED

  @@map("mentor_invitation_status")
}

model MentorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique @map("user_id")
  expertise   String[] // Areas of expertise
  experience  Int?     @default(0) // Years of experience
  linkedin    String?
  twitter     String?
  website     String?
  tagline     String?  // Short professional headline
  description String?  @db.Text // Detailed bio
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  liveStreams       LiveStream[]
  scheduledSessions ScheduledSession[]

  @@map("mentor_profiles")
}

// ========================================
// LIVE STREAMING (AWS IVS) - Enterprise Architecture
// ========================================

// IVS Channel Pool (Admin-managed, reusable)
model IVSChannel {
  id              String    @id @default(cuid())
  channelArn      String    @unique @map("channel_arn")
  channelId       String    @unique @map("channel_id")
  channelName     String    @map("channel_name")
  ingestEndpoint  String    @map("ingest_endpoint")
  playbackUrl     String    @map("playback_url")
  
  // Channel State
  isActive        Boolean   @default(false) @map("is_active")
  isEnabled       Boolean   @default(true) @map("is_enabled") // Admin can disable
  assignedToSessionId String?  @map("assigned_to_session_id")
  
  // Metadata
  totalUsageHours Float     @default(0) @map("total_usage_hours")
  lastUsedAt      DateTime? @map("last_used_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  sessions        ScheduledSession[]
  
  @@index([isActive, isEnabled])
  @@map("ivs_channels")
}

// ========================================
// MENTOR CHANNEL SYSTEM (ONE-CHANNEL-PER-MENTOR)
// Each mentor gets ONE permanent IVS channel for cost optimization
// ========================================

// Mentor's permanent IVS channel (reused for all their classes)
model MentorChannel {
  id              String    @id @default(cuid())
  mentorId        String    @unique @map("mentor_id") // One channel per mentor
  
  // AWS IVS Channel Details
  channelArn      String    @unique @map("channel_arn")
  streamKeyArn    String    @map("stream_key_arn")
  streamKey       String    @db.Text @map("stream_key") // Encrypted backup
  ingestEndpoint  String    @map("ingest_endpoint") // RTMPS server URL
  playbackUrl     String    @map("playback_url") // HLS URL for students
  
  // Metadata
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  mentor          User      @relation("MentorChannel", fields: [mentorId], references: [id], onDelete: Cascade)
  classSessions   ClassSession[]
  
  @@index([mentorId])
  @@map("mentor_channels")
}

// Individual class/session records (tracks when mentor goes live)
model ClassSession {
  id              String              @id @default(cuid())
  classId         String              @map("class_id") // Links to Course
  mentorId        String              @map("mentor_id")
  channelArn      String              @map("channel_arn") // AWS IVS channel ARN
  
  // Session Timing
  startedAt       DateTime            @default(now()) @map("started_at")
  endedAt         DateTime?           @map("ended_at")
  
  // Status
  status          ClassSessionStatus  @default(live)
  viewerCount     Int                 @default(0) @map("viewer_count")
  maxViewerCount  Int                 @default(0) @map("max_viewer_count")
  
  // Metadata
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  // Relations
  mentor          User                @relation("ClassSessionMentor", fields: [mentorId], references: [id], onDelete: Cascade)
  class           Course              @relation("ClassSessions", fields: [classId], references: [id], onDelete: Cascade)
  mentorChannel   MentorChannel?      @relation(fields: [channelArn], references: [channelArn])
  
  @@index([classId])
  @@index([mentorId])
  @@index([status])
  @@index([channelArn])
  @@map("class_sessions")
}

enum ClassSessionStatus {
  scheduled
  live
  ended
  
  @@map("class_session_status")
}

// Session (replaces LiveStream - scheduled by mentor, auto-assigns channel)
model LiveStream {
  id              String           @id @default(cuid())
  mentorProfileId String           @map("mentor_profile_id")
  courseId        String?          @map("course_id")
  title           String
  description     String?          @db.Text
  
  // Channel Assignment (nullable until session starts)
  channelArn      String?          @map("channel_arn")
  channelName     String?          @map("channel_name")
  ingestEndpoint  String?          @map("ingest_endpoint")
  playbackUrl     String?          @map("playback_url")
  streamKeyArn    String?          @map("stream_key_arn")
  
  // Stream Status
  status          LiveStreamStatus @default(CREATED)
  isActive        Boolean          @default(false) @map("is_active")
  
  // Scheduling
  scheduledAt     DateTime?        @map("scheduled_at")
  startedAt       DateTime?        @map("started_at")
  endedAt         DateTime?        @map("ended_at")
  
  // Metadata
  viewerCount     Int              @default(0) @map("viewer_count")
  maxViewers      Int              @default(0) @map("max_viewers")
  
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  mentorProfile    MentorProfile     @relation(fields: [mentorProfileId], references: [id], onDelete: Cascade)
  scheduledSession ScheduledSession?
  course          Course?          @relation(fields: [courseId], references: [id], onDelete: SetNull)
  viewers         StreamViewer[]

  @@index([mentorProfileId])
  @@index([courseId])
  @@index([status])
  @@map("live_streams")
}

model StreamViewer {
  id           String     @id @default(cuid())
  liveStreamId String     @map("live_stream_id")
  userId       String     @map("user_id")
  joinedAt     DateTime   @default(now()) @map("joined_at")
  leftAt       DateTime?  @map("left_at")
  watchTimeMin Int        @default(0) @map("watch_time_min")

  // Relations
  liveStream   LiveStream @relation(fields: [liveStreamId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([liveStreamId, userId])
  @@index([liveStreamId])
  @@index([userId])
  @@map("stream_viewers")
}

enum LiveStreamStatus {
  CREATED
  SCHEDULED
  LIVE
  ENDED
  CANCELLED

  @@map("live_stream_status")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum UserType {
  STUDENT
  MENTOR
  ADMIN

  @@map("user_type")
}

enum Category {
  PROGRAMMING
  WEB_DEVELOPMENT
  MOBILE_DEVELOPMENT
  DATA_SCIENCE
  ARTIFICIAL_INTELLIGENCE
  CLOUD_COMPUTING
  CYBERSECURITY
  DESIGN
  BUSINESS
  MARKETING
  OTHER

  @@map("category")
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT

  @@map("difficulty")
}

// ========================================
// COURSE & CONTENT MANAGEMENT
// ========================================

model Course {
  id             String     @id @default(cuid())
  courseName     String     @map("course_name")
  description    String?
  imageUrl       String     @map("image_url")
  price          Decimal    @db.Decimal(10, 2)
  token          Int        @default(0) // Number of tokens required to enroll       
  category       Category
  difficulty     Difficulty @default(BEGINNER)
  durationHours  Int?       @map("duration_hours")
  language       String     @default("English")
  isActive       Boolean    @default(true) @map("is_active")
  isFeatured     Boolean    @default(false) @map("is_featured")
  learningPathId String?    @map("learning_path_id")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Denormalized for query performance
  ratingAverage Decimal @default(0) @map("rating_average") @db.Decimal(3, 2)
  reviewCount   Int     @default(0) @map("review_count")

  // Relations
  mentor        User                 @relation("CourseMentor", fields: [mentorId], references: [id])
  mentorId      String               @map("mentor_id")
  lessons       Lesson[]
  enrollments   Enrollment[]
  purchaseItems PurchaseItem[]
  reviews       Review[]
  prerequisites CoursePrerequisite[] @relation("Prerequisites")
  requiredFor   CoursePrerequisite[] @relation("RequiredFor")
  tags              CourseTag[]
  learningPath      LearningPath?        @relation(fields: [learningPathId], references: [id])
  bundles           CourseBundle[]
  liveStreams       LiveStream[]
  scheduledSessions ScheduledSession[]
  classSessions     ClassSession[]       @relation("ClassSessions") // Mentor Channel System

  @@index([mentorId])
  @@map("courses")
}

// Represents a structured learning journey
model LearningPath {
  id          String   @id @default(cuid())
  title       String
  description String?
  courses     Course[]

  @@map("learning_paths")
}

// Defines prerequisites for a course
model CoursePrerequisite {
  courseId       String @map("course_id")
  prerequisiteId String @map("prerequisite_id")

  course       Course @relation("Prerequisites", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisite Course @relation("RequiredFor", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@id([courseId, prerequisiteId])
  @@map("course_prerequisites")
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  content     String?  @db.Text
  videoUrl    String?  @map("video_url")
  durationMin Int?     @map("duration_min")
  order       Int
  isPreview   Boolean  @default(false) @map("is_preview")
  courseId    String   @map("course_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  course   Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress LessonProgress[]
  threads  DiscussionThread[]

  @@index([courseId])
  @@map("lessons")
}

model CourseTag {
  id    String  @id @default(cuid())
  name  String  @unique
  color String? @default("#3B82F6") // Hex color for UI

  courses Course[]

  @@map("course_tags")
}

// ========================================
// PRODUCT & PURCHASE SYSTEM
// ========================================

// Represents a sellable package of courses
model Bundle {
  id          String  @id @default(cuid())
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  imageUrl    String? @map("image_url")
  isActive    Boolean @default(true) @map("is_active")

  courses       CourseBundle[]
  purchaseItems PurchaseItem[]

  @@map("bundles")
}

// Join table for Courses and Bundles
model CourseBundle {
  courseId String @map("course_id")
  bundleId String @map("bundle_id")

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  bundle Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@id([courseId, bundleId])
  @@map("course_bundles")
}

// An "order" or "cart" at the time of transaction
model Purchase {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  totalAmount Decimal       @map("total_amount") @db.Decimal(10, 2)
  purchasedAt DateTime      @default(now()) @map("purchased_at")
  status      PaymentStatus @default(PENDING) // Status of the overall purchase

  user     User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  items    PurchaseItem[]
  payments Payment[]

  @@index([userId])
  @@map("purchases")
}

// An item within a purchase (e.g., a course or a bundle)
model PurchaseItem {
  id            String  @id @default(cuid())
  purchaseId    String  @map("purchase_id")
  purchasePrice Decimal @map("purchase_price") @db.Decimal(10, 2)

  // The item can be a course OR a bundle
  courseId String? @map("course_id")
  bundleId String? @map("bundle_id")

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  course   Course?  @relation(fields: [courseId], references: [id])
  bundle   Bundle?  @relation(fields: [bundleId], references: [id])

  @@map("purchase_items")
}

model Payment {
  id                String        @id @default(cuid())
  purchaseId        String        @map("purchase_id")
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("INR")
  status            PaymentStatus @default(PENDING)
  provider          String        @default("razorpay") // e.g., 'razorpay', 'stripe'
  providerPaymentId String        @unique @map("provider_payment_id")
  providerOrderId   String?       @map("provider_order_id")
  signature         String? // For verification (e.g., Razorpay signature)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED

  @@map("payment_status")
}

// ========================================
// ENROLLMENT & PROGRESS
// ========================================

model Enrollment {
  id              String           @id @default(cuid())
  userId          String           @map("user_id")
  courseId        String           @map("course_id")
  enrolledAt      DateTime         @default(now()) @map("enrolled_at")
  completedAt     DateTime?        @map("completed_at")
  lastAccessedAt  DateTime?        @map("last_accessed_at")
  progressPercent Decimal          @default(0) @map("progress_percent") @db.Decimal(5, 2)
  status          EnrollmentStatus @default(ACTIVE)

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]
  certificate    Certificate?

  @@unique([userId, courseId])
  @@map("enrollments")
}

model LessonProgress {
  id           String    @id @default(cuid())
  enrollmentId String    @map("enrollment_id")
  lessonId     String    @map("lesson_id")
  completed    Boolean   @default(false)
  completedAt  DateTime? @map("completed_at")
  timeSpentMin Int?      @map("time_spent_min")

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  PAUSED
  DROPPED

  @@map("enrollment_status")
}

// Certificate issued upon course completion
model Certificate {
  id            String   @id @default(cuid())
  enrollmentId  String   @unique @map("enrollment_id")
  userId        String   @map("user_id")
  courseName    String   @map("course_name") // Denormalized for easy certificate generation
  issuedAt      DateTime @default(now()) @map("issued_at")
  credentialUrl String   @unique @map("credential_url")

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("certificates")
}

// ========================================
// REVIEWS & COMMUNITY
// ========================================

model Review {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  courseId  String   @map("course_id")
  rating    Int // 1-5 stars
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("reviews")
}

// A Q&A thread within a course lesson
model DiscussionThread {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  userId    String   @map("user_id")
  lessonId  String   @map("lesson_id")
  createdAt DateTime @default(now()) @map("created_at")

  author User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  posts  DiscussionPost[]

  @@map("discussion_threads")
}

// A reply/post within a discussion thread
model DiscussionPost {
  id        String   @id @default(cuid())
  content   String   @db.Text
  userId    String   @map("user_id")
  threadId  String   @map("thread_id")
  parentId  String?  @map("parent_id") // For nested replies
  createdAt DateTime @default(now()) @map("created_at")

  author  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread  DiscussionThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  parent  DiscussionPost?  @relation("Replies", fields: [parentId], references: [id], onDelete: NoAction)
  replies DiscussionPost[] @relation("Replies")

  @@map("discussion_posts")
}

// ========================================
// ADMIN, ANALYTICS & NOTIFICATIONS
// ========================================

model AdminAction {
  id          String          @id @default(cuid())
  adminId     String          @map("admin_id")
  action      AdminActionType
  targetType  String          @map("target_type") // 'user', 'course', 'payment', etc.
  targetId    String          @map("target_id")
  description String?
  metadata    Json? // Additional data

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_actions")
}

enum AdminActionType {
  CREATE
  UPDATE
  DELETE
  APPROVE
  REJECT
  SUSPEND
  RESTORE

  @@map("admin_action_type")
}

// Analytics and metrics
model Analytics {
  id       String         @id @default(cuid())
  date     DateTime       @db.Date
  metric   AnalyticMetric
  value    Decimal        @db.Decimal(15, 2)
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([date, metric])
  @@map("analytics")
}

enum AnalyticMetric {
  DAILY_ACTIVE_USERS
  NEW_REGISTRATIONS
  COURSE_COMPLETIONS
  REVENUE
  COURSE_ENROLLMENTS
  LESSON_COMPLETIONS

  @@map("analytic_metric")
}

// Notifications & Communication
model Notification {
  id      String           @id @default(cuid())
  userId  String           @map("user_id")
  title   String
  message String
  type    NotificationType
  read    Boolean          @default(false)
  data    Json? // Additional notification data

  createdAt DateTime  @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum NotificationType {
  COURSE_UPDATE
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  ENROLLMENT_CONFIRMATION
  COURSE_COMPLETION
  NEW_LESSON
  SYSTEM_ANNOUNCEMENT
  LIVE_SESSION_SCHEDULED
  LIVE_SESSION_STARTING
  QUIZ_ASSIGNED

  @@map("notification_type")
}

// ========================================
// ENHANCED LIVE STREAMING & SESSIONS
// ========================================

model ScheduledSession {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  
  // Scheduling
  scheduledAt    DateTime  @map("scheduled_at")
  duration       Int       @default(60) // minutes
  isRecurring    Boolean   @default(false) @map("is_recurring")
  recurrenceRule String?   @map("recurrence_rule") // RRULE format
  
  // Channel Assignment (auto-assigned when session starts)
  ivsChannelId     String?     @map("ivs_channel_id")
  ivsChannel       IVSChannel? @relation(fields: [ivsChannelId], references: [id], onDelete: SetNull)
  currentStreamKey String?     @db.Text @map("current_stream_key") // Temporary, for active session only
  
  // Streaming config
  streamType          StreamType          @default(RTMPS) @map("stream_type")
  useWebRTC           Boolean             @default(false) @map("use_webrtc")
  stageArn            String?             @map("stage_arn") // IVS Real-time Stage ARN
  participantToken    String?             @db.Text @map("participant_token") // WebRTC token
  
  // Features
  enableQuiz       Boolean @default(false) @map("enable_quiz")
  enableAttendance Boolean @default(true) @map("enable_attendance")
  enableChat       Boolean @default(true) @map("enable_chat")
  enableRecording  Boolean @default(false) @map("enable_recording")
  
  // Status
  status    SessionStatus @default(SCHEDULED)
  startedAt DateTime?     @map("started_at")
  endedAt   DateTime?     @map("ended_at")
  
  // Recording
  recordingUrl String? @map("recording_url")
  recordingS3  String? @map("recording_s3")
  thumbnailUrl String? @map("thumbnail_url")
  
  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  mentorProfileId String        @map("mentor_profile_id")
  mentorProfile   MentorProfile @relation(fields: [mentorProfileId], references: [id], onDelete: Cascade)
  
  courseId String? @map("course_id")
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  
  liveStreamId String?     @unique @map("live_stream_id")
  liveStream   LiveStream? @relation(fields: [liveStreamId], references: [id], onDelete: SetNull)
  
  quizzes      SessionQuiz[]
  attendance   SessionAttendance[]
  
  @@index([mentorProfileId])
  @@index([courseId])
  @@index([scheduledAt])
  @@index([status])
  @@index([ivsChannelId])
  @@map("scheduled_sessions")
}

model SessionQuiz {
  id        String   @id @default(cuid())
  question  String   @db.Text
  options   Json // Array of options
  correctAnswer Int  @map("correct_answer") // Index of correct option
  duration  Int      @default(30) // seconds
  points    Int      @default(10)
  
  // Timing
  launchedAt DateTime? @map("launched_at")
  endsAt     DateTime? @map("ends_at")
  
  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  sessionId String           @map("session_id")
  session   ScheduledSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  responses QuizResponse[]
  
  @@index([sessionId])
  @@map("session_quizzes")
}

model QuizResponse {
  id           String   @id @default(cuid())
  answer       Int
  isCorrect    Boolean  @map("is_correct")
  responseTime Int      @map("response_time") // milliseconds
  points       Int      @default(0)
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  quizId String      @map("quiz_id")
  quiz   SessionQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([quizId, userId])
  @@index([quizId])
  @@index([userId])
  @@map("quiz_responses")
}

model SessionAttendance {
  id           String   @id @default(cuid())
  joinedAt     DateTime @default(now()) @map("joined_at")
  leftAt       DateTime? @map("left_at")
  duration     Int      @default(0) // seconds
  isPresent    Boolean  @default(true) @map("is_present")
  
  // Engagement metrics
  chatMessages Int @default(0) @map("chat_messages")
  quizScore    Int @default(0) @map("quiz_score")
  
  // Relations
  sessionId String           @map("session_id")
  session   ScheduledSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("session_attendance")
}

enum StreamType {
  RTMPS  // Traditional RTMPS (OBS)
  WEBRTC // Browser-based WebRTC
  
  @@map("stream_type")
}

enum SessionStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
  
  @@map("session_status")
}
